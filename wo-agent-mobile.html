<!DOCTYPE html>
<html>
<head>
  <title>WO Agent Mobile - PartnerGPT</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- Cache buster: 2025-07-31-v5 -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .header { 
      background-color: #c8102e; 
      color: white; 
      padding: 15px 0; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-inner { 
      max-width: 1000px; 
      margin: 0 auto; 
      padding: 0 20px; 
    }
    
    .nav { 
      display: flex; 
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    
    .nav h1 { 
      margin: 0; 
      font-size: 26px; 
      color: white;
    }

    .nav-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }

    .nav .nav-links {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .nav-button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .nav-button:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .main-content {
      flex: 1;
      padding: 15px;
    }
    
    @media (max-width: 768px) {
      .header {
        padding: 10px 0;
      }

      .header-inner {
        padding: 0 15px;
      }

      .nav h1 {
        font-size: 20px;
      }
      
      .nav-button {
        padding: 6px 12px;
        font-size: 13px;
      }
    }
    
    .generate-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .generate-btn {
      background: #2d2926;
      color: white;
      border: none;
      padding: 15px 25px;
      font-size: 16px;
      border-radius: 25px;
      cursor: pointer;
      width: 100%;
      max-width: 280px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .generate-btn:hover:not(:disabled) {
      background: #1a1916;
      transform: translateY(-1px);
    }
    
    .generate-btn:disabled {
      background: #dee2e6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Mobile Work Order Card */
    .wo-card {
      background: white;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .wo-header {
      background: linear-gradient(135deg, #2d2926, #1a1916);
      color: white;
      padding: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .wo-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .wo-priority {
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .wo-toggle {
      font-size: 18px;
      transition: transform 0.3s;
    }
    
    .wo-toggle.expanded {
      transform: rotate(180deg);
    }
    
    .wo-content {
      padding: 15px;
      display: block;
    }
    
    .wo-quick-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .wo-info-item {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      border-left: 3px solid #c8102e;
    }
    
    .wo-info-label {
      font-size: 14px;
      color: #2d2926;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }
    
    .wo-info-value {
      font-size: 20px;
      font-weight: 600;
      color: #2d2926;
    }
    
    .wo-description {
      background: #fff3e0;
      border: 1px solid #c8102e;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .wo-description-text {
      font-size: 13px;
      color: #2d2926;
      line-height: 1.4;
    }
    
    .wo-description strong {
      display: inline-block;
      margin-bottom: 3px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .wo-description div {
      font-size: 13px;
      line-height: 1.3;
    }
    
    /* Work Order Sections */
    .wo-section {
      background: #f8f9fa;
      border-radius: 8px;
      margin-top: 15px;
      overflow: hidden;
      border-left: 3px solid #c8102e;
    }
    
    .wo-section-header {
      background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
      color: #2d2926;
      padding: 10px 12px;
      font-weight: 600;
      font-size: 18px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .wo-section-content {
      padding: 12px;
    }
    
    .wo-detail-item {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .wo-detail-item:last-child {
      margin-bottom: 0;
    }
    
    .wo-detail-label {
      font-size: 15px;
      color: #2d2926;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .wo-detail-item span:not(.wo-detail-label) {
      font-size: 16px;
      color: #2d2926;
      line-height: 1.4;
    }
    
    .wo-parts-list {
      margin-top: 4px;
    }
    
    .wo-parts-list div {
      font-size: 12px;
      color: #2d2926;
      padding: 2px 0;
      padding-left: 12px;
      position: relative;
    }
    
    .wo-parts-list div::before {
      content: "•";
      position: absolute;
      left: 0;
      color: #2d2926;
      font-weight: bold;
    }
    
    /* Activity Log */
    .activity-log {
      /* Remove max-height and overflow to allow full expansion */
    }
    
    .activity-log-item {
      background: #f8f9fa;
      /* Remove green border */
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.4;
      border: 1px solid #e9ecef;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .activity-log-item.error {
      background: #fff3f3;
      border-color: #f5c6cb;
    }
    
    .activity-timestamp {
      color: #2d2926;
      font-size: 10px;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .activity-content {
      color: #2d2926;
    }
    
    .activity-content a {
      color: #2d2926;
      text-decoration: none;
      font-weight: 500;
    }
    
    .activity-content a:hover {
      text-decoration: underline;
    }
    
    .activity-content strong {
      color: #28a745;
    }
    
    .activity-log-item {
      position: relative;
    }
    
    .activity-main-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .activity-main-content:hover {
      background: rgba(0, 0, 0, 0.02);
      margin: 0 -12px;
      padding: 0 12px;
    }
    
    .activity-main-content:active {
      opacity: 0.8;
    }
    
    .activity-content-left {
      flex: 1;
    }
    
    .activity-raw-content {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin-top: 8px;
      max-height: 200px;
      overflow: auto;
      display: none;
      padding: 0;
    }
    
    .activity-raw-content pre {
      margin: 0;
      padding: 6px;
      font-size: 9px;
      line-height: 1.2;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    /* Mobile Actions */
    .actions-section {
      background: white;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .actions-header {
      background: #2d2926;
      color: white;
      padding: 12px 15px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .actions-count {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    
    .actions-grid {
      padding: 15px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    
    .mobile-action-btn {
      background: #2d2926;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-align: left;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .mobile-action-btn:hover:not(:disabled) {
      background: #1a1916;
      transform: translateY(-1px);
    }
    
    .mobile-action-btn:disabled {
      background: #dee2e6;
      cursor: not-allowed;
      transform: none;
    }
    
    .mobile-action-btn.loading {
      background: #dee2e6;
      cursor: not-allowed;
    }
    
    .mobile-action-btn.completing {
      background: #28a745;
      cursor: not-allowed;
      opacity: 1 !important;
    }
    
    .mobile-action-btn.completing .action-status {
      color: white;
      font-weight: bold;
    }
    
    .action-text {
      flex: 1;
      margin-right: 10px;
    }
    
    .action-status {
      font-size: 18px;
    }
    
    .mobile-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    
    
    
    
    /* Loading States */
    .loading-placeholder {
      text-align: center;
      padding: 20px;
      color: #2d2926;
      font-style: italic;
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .loading-dots {
      display: inline-block;
      margin-left: 5px;
    }
    
    .loading-dots::after {
      content: '';
      animation: loading-dots 1.5s infinite;
    }
    
    @keyframes loading-dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
    
    /* Responsive adjustments */
    @media (min-width: 480px) {
      .wo-quick-info {
        grid-template-columns: 1fr 1fr 1fr;
      }
      
      .actions-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .completed-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (min-width: 768px) {
      body {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      
      .actions-grid {
        grid-template-columns: 1fr 1fr 1fr;
      }
      
      .completed-grid {
        grid-template-columns: 1fr 1fr 1fr;
      }
      
      .wo-quick-info {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    /* Large phone landscape */
    @media (max-width: 812px) and (orientation: landscape) {
      .mobile-header {
        padding: 10px;
      }
      
      .mobile-header h1 {
        font-size: 18px;
        margin-bottom: 2px;
      }
      
      .mobile-header .subtitle {
        font-size: 12px;
      }
      
      .wo-card, .actions-section, .completed-section, .results-section {
        margin-bottom: 10px;
      }
    }
    
    /* Hidden sections */
    .hidden {
      display: none !important;
    }
    
    /* Refresh button styles */
    .nav-icon-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .nav-icon-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .nav-icon-button svg {
      transition: transform 0.2s ease;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Loading state styles */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      gap: 20px;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #c8102e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .loading-text {
      color: #666;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="nav">
        <h1>PartnerGPT</h1>
        <div class="nav-center">WO</div>
        <div class="nav-links">
          <button id="refreshWO" class="nav-icon-button" title="Generate New Work Order">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M1 4v6h6M23 20v-6h-6"/>
              <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
            </svg>
          </button>
          <a href="/partnerplus" class="nav-button">Chat</a>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">

  <div id="workOrderCard" class="wo-card hidden">
    <div class="wo-header" onclick="toggleWorkOrder()">
      <div>
        <div class="wo-title" id="woTitle">Work Order</div>
      </div>
      <div class="wo-toggle expanded" id="woToggle">▼</div>
    </div>
    <div class="wo-content" id="woContent">
      <div class="wo-quick-info">
        <div class="wo-info-item">
          <div class="wo-info-label">Make</div>
          <div class="wo-info-value" id="woMake">Loading...</div>
        </div>
        <div class="wo-info-item">
          <div class="wo-info-label">Model</div>
          <div class="wo-info-value" id="woModel">Loading...</div>
        </div>
      </div>
      
      <!-- Location & Contact Section -->
      <div class="wo-section">
        <div class="wo-section-header">📍 Location & Contact</div>
        <div class="wo-section-content">
          <div class="wo-detail-item">
            <span class="wo-detail-label">Location:</span>
            <span id="woLocation">Loading...</span>
          </div>
          <div class="wo-detail-item">
            <span class="wo-detail-label">Contact:</span>
            <span id="woContact">Loading...</span>
          </div>
          <div class="wo-detail-item">
            <span class="wo-detail-label">Phone:</span>
            <span id="woPhone">Loading...</span>
          </div>
        </div>
      </div>
      
      <!-- Issue Details Section -->
      <div class="wo-section">
        <div class="wo-section-header">📋 Issue Details</div>
        <div class="wo-section-content">
          <div class="wo-detail-item">
            <span class="wo-detail-label">Description:</span>
            <div id="woIssue" style="margin-top: 5px;">Loading...</div>
          </div>
        </div>
      </div>
      
      <div class="wo-section" id="activityLogSection" style="display: none;">
        <div class="wo-section-header">📝 Activity Log</div>
        <div class="wo-section-content">
          <div id="activityLog" class="activity-log"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="actionsSection" class="actions-section hidden">
    <div class="actions-header">
      <span>Recommended Actions</span>
      <span class="actions-count" id="actionsCount">0</span>
    </div>
    <div class="actions-grid" id="actionsGrid">
      <div class="loading-placeholder">
        Generating recommendations<span class="loading-dots"></span>
      </div>
    </div>
  </div>


  <script>
    let currentWorkOrder = null;
    let actionResults = [];

    // Auto-generate work order on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('DOMContentLoaded - starting work order generation');
      generateRandomWorkOrder();
    });
    
    // Handle refresh button
    document.getElementById('refreshWO').addEventListener('click', function() {
      const button = this;
      button.disabled = true;
      
      // Reset all data
      currentWorkOrder = null;
      actionResults = [];
      resetSections();
      
      // Generate new work order
      generateRandomWorkOrder();
      
      // Re-enable button after a short delay
      setTimeout(() => {
        button.disabled = false;
      }, 500);
    });

    function toggleWorkOrder() {
      const content = document.getElementById('woContent');
      const toggle = document.getElementById('woToggle');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.classList.add('expanded');
      } else {
        content.style.display = 'none';
        toggle.classList.remove('expanded');
      }
    }

    async function generateRandomWorkOrder() {
      console.log('generateRandomWorkOrder called');
      // Show loading state in work order card  
      const workOrderCard = document.getElementById('workOrderCard');
      workOrderCard.classList.remove('hidden');
      
      // Show loading content
      document.getElementById('woContent').innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <div class="loading-text">Generating work order...</div>
        </div>
      `;

      // Reset other sections but keep WO card visible
      resetSections();

      try {
        const response = await fetch('/api/generate-work-order');
        console.log('Work order response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const workOrder = await response.json();
        console.log('Work order data:', workOrder);
        
        currentWorkOrder = workOrder;
        displayWorkOrder(workOrder);
        
        // Work order is already expanded by default

        // Generate action recommendations
        setTimeout(() => generateActionRecommendations(), 1000);
        
      } catch (error) {
        console.error('Error generating work order:', error);
        document.getElementById('woContent').innerHTML = `
          <div style="text-align: center; padding: 20px; color: #dc3545;">
            Failed to generate work order: ${error.message}<br>
            Please try again.
          </div>
        `;
      }
    }

    function resetSections() {
      // Work order stays visible and expanded
      
      // Reset actions
      const actionsSection = document.getElementById('actionsSection');
      if (actionsSection) {
        actionsSection.classList.add('hidden');
      }
      
      const actionsGrid = document.getElementById('actionsGrid');
      if (actionsGrid) {
        actionsGrid.innerHTML = '<div class="loading-placeholder">Generating recommendations<span class="loading-dots"></span></div>';
      }
      
      // Reset activity log
      const activityLogSection = document.getElementById('activityLogSection');
      if (activityLogSection) {
        activityLogSection.style.display = 'none';
      }
      
      const activityLog = document.getElementById('activityLog');
      if (activityLog) {
        activityLog.innerHTML = '';
      }
      
      // Reset data
      actionResults = [];
      
      // Only call updateCounts if the function exists
      if (typeof updateCounts === 'function') {
        updateCounts();
      }
    }

    function displayWorkOrder(workOrder) {
      console.log('displayWorkOrder called with:', workOrder);
      // Restore the work order content structure
      document.getElementById('woContent').innerHTML = `
        <div class="wo-quick-info">
          <div class="wo-info-item">
            <div class="wo-info-label">Make</div>
            <div class="wo-info-value" id="woMake">Loading...</div>
          </div>
          <div class="wo-info-item">
            <div class="wo-info-label">Model</div>
            <div class="wo-info-value" id="woModel">Loading...</div>
          </div>
        </div>
        <div class="wo-section">
          <div class="wo-section-header">📍 Restaurant Details</div>
          <div class="wo-section-content">
            <div class="wo-detail-item">
              <span class="wo-detail-label">Location:</span>
              <span id="woLocation">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Address:</span>
              <span id="woAddress">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Contact:</span>
              <span id="woContact">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Phone:</span>
              <span id="woPhone">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Email:</span>
              <span id="woEmail">Loading...</span>
            </div>
          </div>
        </div>
        <div class="wo-section">
          <div class="wo-section-header">🔧 Technician Details</div>
          <div class="wo-section-content">
            <div class="wo-detail-item">
              <span class="wo-detail-label">Name:</span>
              <span id="techName">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Phone:</span>
              <span id="techPhone">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Email:</span>
              <span id="techEmail">Loading...</span>
            </div>
          </div>
        </div>
        <div class="wo-section">
          <div class="wo-section-header">📋 Issue Details</div>
          <div class="wo-section-content">
            <div class="wo-detail-item">
              <span class="wo-detail-label">Dispatch Notes:</span>
              <span id="woDispatchNotes">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Tech Notes:</span>
              <span id="woTechNotes">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Suspected Parts:</span>
              <span id="woSuspectedParts">Loading...</span>
            </div>
          </div>
        </div>
        <div class="wo-section" id="activityLogSection" style="display: none;">
          <div class="wo-section-header">📝 Activity Log</div>
          <div class="wo-section-content">
            <div id="activityLog" class="activity-log"></div>
          </div>
        </div>
      `;
      
      // Header info
      document.getElementById('woTitle').textContent = `WO #${workOrder.id}`;
      
      // Quick info section - split equipment into make and model
      const equipmentParts = workOrder.equipment.split(' ');
      const make = equipmentParts[0];
      const model = equipmentParts.slice(1).join(' ');
      document.getElementById('woMake').textContent = make;
      document.getElementById('woModel').textContent = model;
      
      // Location & Contact section
      document.getElementById('woLocation').textContent = workOrder.locationName || workOrder.customer || 'N/A';
      document.getElementById('woAddress').textContent = workOrder.address || 'N/A';
      document.getElementById('woContact').textContent = workOrder.locationContactName || workOrder.contact || 'N/A';
      document.getElementById('woPhone').textContent = workOrder.locationContactPhone || 'N/A';
      document.getElementById('woEmail').textContent = workOrder.locationContactEmail || 'N/A';
      
      // Technician section
      document.getElementById('techName').textContent = workOrder.technicianName || workOrder.technician || 'N/A';
      document.getElementById('techPhone').textContent = workOrder.technicianPhone || 'N/A';
      document.getElementById('techEmail').textContent = workOrder.technicianEmail || 'N/A';
      
      // Issue Details section
      document.getElementById('woDispatchNotes').textContent = workOrder.dispatchNotes || workOrder.description || 'No dispatch notes available';
      document.getElementById('woTechNotes').textContent = workOrder.serviceNotes || 'No tech notes available';
      document.getElementById('woSuspectedParts').textContent = workOrder.suspectedParts ? workOrder.suspectedParts.join(', ') : 'No parts identified';
      
      document.getElementById('workOrderCard').classList.remove('hidden');
    }

    async function generateActionRecommendations(isFollowUp = false) {
      document.getElementById('actionsSection').classList.remove('hidden');
      
      try {
        // Get activity log context for follow-up actions
        const activityContext = getActivityLogContext();
        const activityContextText = activityContext.length > 0 ? `

=== COMPLETED ACTIONS & CUMULATIVE INTELLIGENCE ===
${activityContext.map((item) => `
ACTION ${item.actionNumber}: [${item.timestamp}]
SUMMARY: ${item.summary}
COMPLETE RAW API RESPONSE:
${item.rawData}
---
`).join('')}

=== CUMULATIVE CONTEXT ANALYSIS ===
Total Actions Completed: ${activityContext.length}
Knowledge Base: All raw API responses above contain the complete discovered information including:
- Exact part numbers, prices, availability
- Supplier contact details, addresses, phone numbers
- Manual links, technical specifications, troubleshooting steps
- Service provider locations, ratings, contact information
- Previous communication records and customer interactions

CRITICAL: Analyze the completed actions above and their detailed API responses to generate INTELLIGENT NEXT STEPS that:
- Use specific part numbers, supplier info, prices, and contact details found in the raw data
- Reference specific manual pages, error codes, or technical details discovered
- Build logically on what was already accomplished (don't repeat completed work)
- Progress the repair workflow toward resolution` : '';

        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `Generate exactly ${isFollowUp ? getCurrentActionGap() : '4'} recommended actions. 

CRITICAL FORMAT REQUIREMENTS:
- Output ONLY the action descriptions, one per line
- NO introductory text like "Here are the actions" 
- NO questions like "Would you like to proceed?"
- NO explanatory text or context
- NO numbered lists or bullet points
- Just the pure action descriptions

WORK ORDER:

=== COMPLETE WORK ORDER DETAILS ===
WO Number: ${currentWorkOrder.workOrderNumber || 'WO-1023'}
Equipment: ${currentWorkOrder.equipment}
Model: ${currentWorkOrder.model || 'Unknown model'}
Serial: ${currentWorkOrder.serial || 'Unknown serial'}
Status: ${currentWorkOrder.status || 'In Progress'}
Duration: ${currentWorkOrder.duration || 'Unknown'}
Type: ${currentWorkOrder.type || 'Service Call'}

ISSUE DESCRIPTION:
${currentWorkOrder.dispatchNotes || currentWorkOrder.description}

CUSTOMER & LOCATION:
Customer: ${currentWorkOrder.customer || currentWorkOrder.locationName}
Address: ${currentWorkOrder.address}
Contact: ${currentWorkOrder.locationContactName}
Phone: ${currentWorkOrder.locationContactPhone}
Email: ${currentWorkOrder.locationContactEmail}

TECHNICIAN ASSIGNMENT:
Technician: ${currentWorkOrder.technicianName}
Phone: ${currentWorkOrder.technicianPhone}
Email: ${currentWorkOrder.technicianEmail}

SERVICE DETAILS:
Technician Notes: ${currentWorkOrder.serviceNotes || 'No tech notes yet'}
Suspected Parts: ${(currentWorkOrder.suspectedParts || []).join(', ') || 'None identified yet'}
Priority: ${currentWorkOrder.priority || 'Standard'}${activityContextText}

AVAILABLE API TOOLS TO USE:
- /api/purchase-agent/parts/resolve - Find OEM part number for ONE specific part description
- /api/purchase-agent/suppliers/search - Find suppliers and pricing for parts
- /api/purchase-agent/manuals/search - Get technical manuals and documentation
- /api/purchase-agent/search/web - AI web search for technical info
- /api/purchase-agent/service/search - Find local service providers
- /api/email/send - Send status updates, quotes, or notifications
- /api/sms/send - Send urgent alerts or assignments
- /api/orchestrator/objective - Create multi-step workflows

${isFollowUp ? 
`FOLLOW-UP ACTION GENERATION RULES:
1. LEVERAGE COMPLETED WORK: Extract specific part numbers, prices, supplier names, manual references, and technical details from the completed actions above
2. LOGICAL NEXT STEPS: Generate actions that logically follow from discoveries (e.g., if part found → search suppliers, if manual found → reference specific pages, if suppliers found → compare prices)
3. USE SPECIFIC DATA: Reference exact part numbers, supplier names, prices, manual page numbers, error codes from the raw API responses
4. AVOID REPETITION: Never suggest actions that duplicate completed work
5. PROGRESS WORKFLOW: Move toward order placement, scheduling, customer communication, or technical resolution

EXAMPLES OF INTELLIGENT FOLLOW-UP ACTIONS:
- "Compare suppliers for thermocouple 00-920883-00003 and send quote to Clara"
- "Use service manual page 15 to troubleshoot E03 error code"  
- "Order heating element from WebstaurantStore ($47.99) for next-day delivery"
- "Schedule callback with technician after parts arrive"
- "Email Clara Thompson repair timeline and cost estimate"` 
: 
`INITIAL ACTION GENERATION RULES:
1. SMART PRIORITIZATION: Start with part resolution for suspected parts, then manuals for troubleshooting
2. CONTEXT AWARENESS: Use actual equipment make/model, customer names, technician info, and service notes
3. VARIETY: Mix part resolution, manual searches, and communication actions
4. NO SUPPLIER SEARCHES: Only suggest supplier searches if explicit part numbers are available
5. RELEVANCE: All actions must directly relate to the reported issue and suspected parts

GENERATE DIVERSE ACTIONS LIKE:
- "Resolve [specific part] part number for [exact equipment model]"
- "Find service manual for [equipment] to diagnose [error code/symptom]"  
- "Send status update to [customer name] about [specific issue]"
- "Search for [equipment] troubleshooting guides"
- "Find local service providers for [equipment type] in [location]"`}

Format: Concise action statements, 8-12 words each.

FINAL REMINDER: Output ONLY the ${isFollowUp ? getCurrentActionGap() : '4'} action descriptions, nothing else!`
          })
        });

        const data = await response.json();
        const actionsText = data.response;
        
        // Parse actions from AI response
        const actions = parseActionsFromText(actionsText);
        
        if (isFollowUp) {
          // Append to existing actions
          appendMobileActions(actions);
        } else {
          // Replace all actions
          displayMobileActions(actions);
        }
        
      } catch (error) {
        console.error('Error generating actions:', error);
        if (!isFollowUp) {
          document.getElementById('actionsGrid').innerHTML = '<div class="loading-placeholder">Failed to generate actions</div>';
        }
      }
    }

    function parseActionsFromText(text) {
      const lines = text.split('\n').filter(line => line.trim());
      const actions = [];
      
      lines.forEach(line => {
        // Clean up markdown formatting, arrows, and other unwanted characters
        const cleanLine = line
          .replace(/^\d+\.?\s*|\*\s*|-\s*/g, '') // Remove bullets and numbers
          .replace(/^▶\s*/g, '') // Remove arrow markers
          .replace(/^\>\s*/g, '') // Remove quote markers
          .replace(/^Here are.*actions?:?/i, '') // Remove intro text
          .replace(/^for the work order:?/i, '') // Remove "for the work order" text
          .replace(/Would you like.*$/i, '') // Remove questions
          .replace(/If you'd like to proceed.*$/i, '') // Remove outro text
          .replace(/^\*\*(.+)\*\*$/, '$1') // Remove bold markdown
          .trim();
          
        if (cleanLine && 
            cleanLine.length > 10 && 
            !cleanLine.match(/^(Here|If|Would|for the|Let me)/i) &&
            !cleanLine.includes('?')) {  // Exclude questions
          // Determine action type based on keywords
          let type = 'general';
          const lowerLine = cleanLine.toLowerCase();
          
          if (lowerLine.includes('resolve') || lowerLine.includes('oem') || lowerLine.includes('part number')) {
            type = 'parts_search';
          } else if (lowerLine.includes('supplier') || lowerLine.includes('vendor') || lowerLine.includes('pricing')) {
            type = 'supplier_search';
          } else if (lowerLine.includes('manual') || lowerLine.includes('documentation') || lowerLine.includes('retrieve')) {
            type = 'manual_search';
          } else if (lowerLine.includes('web search') || lowerLine.includes('troubleshooting') || lowerLine.includes('search for')) {
            type = 'web_search';
          } else if (lowerLine.includes('email') || lowerLine.includes('notify') || lowerLine.includes('status update')) {
            type = 'email';
          } else if (lowerLine.includes('sms') || lowerLine.includes('text') || lowerLine.includes('urgent')) {
            type = 'sms';
          } else if (lowerLine.includes('service provider') || lowerLine.includes('local service') || lowerLine.includes('backup')) {
            type = 'service_search';
          } else if (lowerLine.includes('workflow') || lowerLine.includes('multi-step') || lowerLine.includes('create')) {
            type = 'orchestrator';
          }
          
          actions.push({
            name: cleanLine,
            type: type
          });
        }
      });
      
      return actions.slice(0, 8); // Limit to 8 actions
    }

    function displayMobileActions(actions) {
      const actionsGrid = document.getElementById('actionsGrid');
      actionsGrid.innerHTML = '';
      
      actions.forEach((action, index) => {
        const button = document.createElement('button');
        button.className = 'mobile-action-btn';
        button.innerHTML = `
          <div class="action-text">${action.name}</div>
          <div class="action-status">▶</div>
        `;
        button.onclick = () => executeAction(action, button, index);
        actionsGrid.appendChild(button);
      });
      
      updateCounts();
    }
    
    function appendMobileActions(actions) {
      const actionsGrid = document.getElementById('actionsGrid');
      
      actions.forEach((action, index) => {
        const button = document.createElement('button');
        button.className = 'mobile-action-btn';
        button.innerHTML = `
          <div class="action-text">${action.name}</div>
          <div class="action-status">▶</div>
        `;
        button.onclick = () => executeAction(action, button, index);
        actionsGrid.appendChild(button);
      });
      
      updateCounts();
    }

    async function executeAction(action, button, actionIndex) {
      button.classList.add('loading');
      button.disabled = true;
      button.querySelector('.action-status').innerHTML = '<div class="mobile-spinner"></div>';

      try {
        // Generate action parameters (simplified for mobile)
        const actionConfig = generateActionConfig(action.type, action.name);
        
        let url = actionConfig.endpoint;
        let requestBody = null;
        
        if (actionConfig.method === 'GET') {
          const params = new URLSearchParams(actionConfig.params);
          url += '?' + params.toString();
        } else {
          requestBody = JSON.stringify(actionConfig.params);
        }

        const response = await fetch(url, {
          method: actionConfig.method,
          headers: actionConfig.method === 'POST' ? { 'Content-Type': 'application/json' } : {},
          body: requestBody
        });

        const result = await response.json();
        
        // Move to completed (this will log the activity)
        await moveToCompleted(button, action, result);
        
      } catch (error) {
        console.error('Error executing action:', error);
        const errorResult = { error: error.message };
        await moveToCompleted(button, action, errorResult);
      }
    }

    function generateActionConfig(actionType, actionName) {
      const zipMatch = currentWorkOrder.address?.match(/\b\d{5}\b/);
      const zipCode = zipMatch ? zipMatch[0] : "12345";
      const equipmentParts = currentWorkOrder.equipment.split(' ');
      const make = equipmentParts[0] || "Unknown";

      const configs = {
        parts_search: {
          endpoint: '/api/purchase-agent/parts/resolve',
          method: 'POST',
          params: {
            description: extractPartFromAction(actionName),
            make: make,
            model: currentWorkOrder.equipment
          }
        },
        supplier_search: {
          endpoint: '/api/purchase-agent/suppliers/search',
          method: 'POST',
          params: {
            partNumber: extractPartNumberFromAction(actionName) || 'GENERIC-PART',
            options: { make: make, limit: 5 }
          }
        },
        service_search: {
          endpoint: '/api/purchase-agent/service/search',
          method: 'GET',
          params: {
            zipCode: zipCode,
            make: make
          }
        },
        manual_search: {
          endpoint: '/api/purchase-agent/manuals/search',
          method: 'GET',
          params: {
            make: make,
            model: currentWorkOrder.equipment.split(' ').slice(1).join(' ') || 'Unknown'
          }
        },
        web_search: {
          endpoint: '/api/purchase-agent/search/web',
          method: 'POST',
          params: {
            query: `${currentWorkOrder.equipment} ${extractPartFromAction(actionName)} repair troubleshooting`
          }
        },
        email: {
          endpoint: '/api/email/send',
          method: 'POST',
          params: {
            to: currentWorkOrder.locationContactEmail || 'customer@example.com',
            subject: `Work Order #${currentWorkOrder.id} - Service Update`,
            text: generateEmailContent(actionName, currentWorkOrder)
          }
        },
        sms: {
          endpoint: '/api/sms/send',
          method: 'POST',
          params: {
            to: formatPhoneNumber(currentWorkOrder.technicianPhone || currentWorkOrder.locationContactPhone),
            message: `WO #${currentWorkOrder.id}: ${actionName}`
          }
        },
        orchestrator: {
          endpoint: '/api/orchestrator/objective',
          method: 'POST',
          params: {
            objective: `${actionName} for ${currentWorkOrder.equipment} at ${currentWorkOrder.customer}`
          }
        },
        general: {
          endpoint: '/api/chat',
          method: 'POST',
          params: {
            message: `Help me with this work order task: ${actionName}. Context: ${currentWorkOrder.equipment} - ${currentWorkOrder.dispatchNotes || currentWorkOrder.description}`
          }
        }
      };

      return configs[actionType] || configs.general;
    }

    function extractPartFromAction(actionName) {
      const lowerAction = actionName.toLowerCase();
      const partKeywords = ['part', 'component', 'seal', 'gasket', 'motor', 'pump', 'valve', 'belt', 'filter', 'element'];
      
      for (const keyword of partKeywords) {
        if (lowerAction.includes(keyword)) {
          const words = actionName.split(' ');
          const keywordIndex = words.findIndex(word => word.toLowerCase().includes(keyword));
          if (keywordIndex >= 0) {
            return words.slice(Math.max(0, keywordIndex - 1), keywordIndex + 2).join(' ');
          }
        }
      }
      
      return actionName.split(' ').slice(0, 3).join(' ');
    }

    function extractPartNumberFromAction(actionName) {
      // Look for common part number patterns
      const partNumberPattern = /[A-Z0-9]{3,}-?[A-Z0-9]{2,}/gi;
      const matches = actionName.match(partNumberPattern);
      if (matches) {
        return matches[0];
      }
      
      // Extract from suspected parts if available
      if (currentWorkOrder.suspectedParts && currentWorkOrder.suspectedParts.length > 0) {
        return currentWorkOrder.suspectedParts[0];
      }
      
      // Fallback to generic search terms from action
      const lowerAction = actionName.toLowerCase();
      if (lowerAction.includes('thermocouple')) return 'THERMOCOUPLE';
      if (lowerAction.includes('control board')) return 'CONTROL-BOARD';
      if (lowerAction.includes('temp sensor')) return 'TEMP-SENSOR';
      if (lowerAction.includes('ignitor')) return 'IGNITOR';
      if (lowerAction.includes('valve')) return 'GAS-VALVE';
      
      return 'GENERIC-PART';
    }

    function formatPhoneNumber(phone) {
      if (!phone) return '+15024456053'; // Default fallback
      
      // Remove all non-digits
      const cleaned = phone.replace(/\D/g, '');
      
      // Handle different formats
      if (cleaned.length === 10) {
        return `+1${cleaned}`;
      } else if (cleaned.length === 11 && cleaned.startsWith('1')) {
        return `+${cleaned}`;
      } else if (cleaned.length === 11) {
        return `+1${cleaned.slice(1)}`;
      }
      
      return `+1${cleaned.slice(-10)}`; // Take last 10 digits
    }

    function generateEmailContent(actionName, workOrder) {
      const customerName = workOrder.locationContactName || 'Valued Customer';
      const equipment = workOrder.equipment || 'equipment';
      const issue = workOrder.dispatchNotes || workOrder.description || 'service issue';
      
      if (actionName.toLowerCase().includes('status update')) {
        return `Dear ${customerName},

This is an update regarding your service request for the ${equipment} at ${workOrder.address || 'your location'}.

Issue: ${issue}
Technician: ${workOrder.technicianName || 'Our service team'}
Status: Work in progress

We will keep you informed of any developments.

Best regards,
PartnerGPT Service Team`;
      } else if (actionName.toLowerCase().includes('parts')) {
        return `Dear ${customerName},

We have identified the parts needed for your ${equipment} repair:

Issue: ${issue}
Required parts are being sourced and will be ordered shortly.

We will contact you with delivery timeframes and next steps.

Best regards,
PartnerGPT Service Team`;
      } else {
        return `Dear ${customerName},

Regarding your service request for ${equipment}:

${actionName}

We will keep you updated on progress.

Best regards,
PartnerGPT Service Team`;
      }
    }

    function extractPhoneFromContact(contact) {
      const phoneMatch = contact.match(/\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/);
      return phoneMatch ? phoneMatch[0].replace(/\D/g, '').replace(/^(\d{3})(\d{3})(\d{4})$/, '+1$1$2$3') : '+15024456053';
    }

    async function logActivity(action, result) {
      try {
        // Generate formatted log entry
        const logEntry = await generateActivityLogEntry(action, result);
        
        // Show activity log section
        const activitySection = document.getElementById('activityLogSection');
        if (activitySection) {
          activitySection.style.display = 'block';
        } else {
          console.error('Activity log section not found!');
          return;
        }
        
        // Create log item
        const logItem = document.createElement('div');
        logItem.className = `activity-log-item ${result.error ? 'error' : ''}`;
        
        const timestamp = new Date().toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        });
        
        const rawToggleId = `raw-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        logItem.innerHTML = `
          <div class="activity-timestamp">${timestamp}</div>
          <div class="activity-main-content" onclick="toggleActivityRaw('${rawToggleId}')">
            <div class="activity-content-left">
              <div class="activity-content">${logEntry}</div>
            </div>
          </div>
          <div id="${rawToggleId}" class="activity-raw-content">
            <pre>${JSON.stringify(result, null, 2)}</pre>
          </div>
        `;
        
        // Add to log (newest at bottom)
        const activityLog = document.getElementById('activityLog');
        if (activityLog) {
          activityLog.appendChild(logItem);
        } else {
          console.error('Activity log container not found!');
        }
        
        // Store result
        actionResults.push({ action, result, timestamp: Date.now() });
      } catch (error) {
        console.error('Failed to log activity:', error);
      }
    }

    async function moveToCompleted(button, action, result) {
      // Show completing state
      button.classList.add('completing');
      button.querySelector('.action-status').innerHTML = '✓';
      button.querySelector('.action-text').style.opacity = '0.6';
      
      // Log the activity
      await logActivity(action, result);
      
      // Fade out the button
      button.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
      button.style.opacity = '0';
      button.style.transform = 'scale(0.95)';
      
      // Remove button after animation
      setTimeout(() => {
        button.remove();
        updateCounts();
        
        // Auto-generate follow-up actions immediately when less than 4 actions remain
        const actionGap = getCurrentActionGap();
        if (actionGap > 0) { // Only generate if we need actions to reach exactly 4
          // Generate immediately without delay
          generateActionRecommendations(true); // Generate follow-up actions
        }
      }, 300);
    }

    async function generateActivityLogEntry(action, result) {
      try {
        const prompt = `Create a clean work order activity entry for this action:

Action: ${action.name}
Result: ${JSON.stringify(result, null, 2)}

Instructions:
- Write a brief, professional summary of what was accomplished
- Include key details like part numbers, prices, contact info when available
- Make URLs clickable using standard HTML link format
- Use simple formatting - bold for emphasis, no markdown
- Keep it concise and work-order appropriate
- Do NOT include code blocks, markdown syntax, or HTML formatting in the visible text

Examples:
• Found service manual for Hobart AM15 - <a href="manual-url" target="_blank">View Manual</a>
• Located water filter part #00-067500-00072, 441 available in stock
• Contacted Linda Carter at (206) 555-4321 regarding maintenance status

Return only the clean, readable log entry text.`;

        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: prompt })
        });

        const data = await response.json();
        return data.response || 'Action completed';
      } catch (error) {
        console.error('Activity log generation failed:', error);
        return `${action.type === 'error' ? '❌' : '✅'} ${action.name}`;
      }
    }


    function toggleActivityRaw(toggleId) {
      const rawContent = document.getElementById(toggleId);
      const isHidden = rawContent.style.display === 'none' || !rawContent.style.display;
      rawContent.style.display = isHidden ? 'block' : 'none';
    }

    function updateCounts() {
      const activeActions = document.querySelectorAll('.mobile-action-btn').length;
      document.getElementById('actionsCount').textContent = activeActions;
    }
    
    function getCurrentActionGap() {
      const currentCount = document.querySelectorAll('.mobile-action-btn').length;
      const targetCount = 4;
      const gap = targetCount - currentCount;
      return Math.max(0, gap); // Only generate what's needed to reach exactly 4, never exceed
    }
    
    function getActivityLogContext() {
      const activityItems = document.querySelectorAll('.activity-log-item');
      const context = [];
      
      activityItems.forEach((item, index) => {
        const timestamp = item.querySelector('.activity-timestamp').textContent;
        const content = item.querySelector('.activity-content').textContent.replace('Raw Data', '').replace('▼', '').replace('▲', '').trim();
        const rawContent = item.querySelector('.activity-raw-content pre').textContent;
        
        context.push({
          actionNumber: index + 1,
          timestamp,
          summary: content,
          rawData: rawContent
        });
      });
      
      return context;
    }
  </script>
  </div>
</body>
</html>