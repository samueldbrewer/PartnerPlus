<!DOCTYPE html>
<html>
<head>
  <title>WO Agent Mobile - PartnerGPT</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- Cache buster: 2025-07-31-v5 -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .header { 
      background-color: #c8102e; 
      color: white; 
      padding: 15px 0; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-inner { 
      max-width: 1000px; 
      margin: 0 auto; 
      padding: 0 20px; 
    }
    
    .nav { 
      display: flex; 
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    
    .nav h1 { 
      margin: 0; 
      font-size: 26px; 
      color: white;
    }

    .nav-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }

    .nav .nav-links {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .nav-button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .nav-button:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .main-content {
      flex: 1;
      padding: 15px;
    }
    
    @media (max-width: 768px) {
      .header {
        padding: 10px 0;
      }

      .header-inner {
        padding: 0 15px;
      }

      .nav h1 {
        font-size: 20px;
      }
      
      .nav-button {
        padding: 6px 12px;
        font-size: 13px;
      }
    }
    
    .generate-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .generate-btn {
      background: #2d2926;
      color: white;
      border: none;
      padding: 15px 25px;
      font-size: 16px;
      border-radius: 25px;
      cursor: pointer;
      width: 100%;
      max-width: 280px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .generate-btn:hover:not(:disabled) {
      background: #1a1916;
      transform: translateY(-1px);
    }
    
    .generate-btn:disabled {
      background: #dee2e6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Mobile Work Order Card */
    .wo-card {
      background: white;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .wo-header {
      background: linear-gradient(135deg, #2d2926, #1a1916);
      color: white;
      padding: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .wo-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .wo-priority {
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .wo-toggle {
      font-size: 18px;
      transition: transform 0.3s;
    }
    
    .wo-toggle.expanded {
      transform: rotate(180deg);
    }
    
    .wo-content {
      padding: 15px;
      display: block;
    }
    
    .wo-quick-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .wo-info-item {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      border-left: 3px solid #c8102e;
    }
    
    .wo-info-label {
      font-size: 14px;
      color: #2d2926;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }
    
    .wo-info-value {
      font-size: 20px;
      font-weight: 600;
      color: #2d2926;
    }
    
    .wo-description {
      background: #fff3e0;
      border: 1px solid #c8102e;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .wo-description-text {
      font-size: 13px;
      color: #2d2926;
      line-height: 1.4;
    }
    
    .wo-description strong {
      display: inline-block;
      margin-bottom: 3px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .wo-description div {
      font-size: 13px;
      line-height: 1.3;
    }
    
    /* Work Order Sections */
    .wo-section {
      background: #f8f9fa;
      border-radius: 8px;
      margin-top: 15px;
      overflow: hidden;
      border-left: 3px solid #c8102e;
    }
    
    .wo-section-header {
      background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
      color: #2d2926;
      padding: 10px 12px;
      font-weight: 600;
      font-size: 18px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .wo-section-content {
      padding: 12px;
    }
    
    .wo-detail-item {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    /* Add extra spacing for Issue Details section items */
    .issue-details-item {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .issue-details-item:last-child {
      margin-bottom: 0;
    }
    
    .wo-detail-item:last-child {
      margin-bottom: 0;
    }
    
    .wo-detail-label {
      font-size: 15px;
      color: #2d2926;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .wo-detail-item span:not(.wo-detail-label) {
      font-size: 16px;
      color: #2d2926;
      line-height: 1.4;
    }
    
    .wo-parts-list {
      margin-top: 4px;
    }
    
    .wo-parts-list div {
      font-size: 12px;
      color: #2d2926;
      padding: 2px 0;
      padding-left: 12px;
      position: relative;
    }
    
    .wo-parts-list div::before {
      content: "‚Ä¢";
      position: absolute;
      left: 0;
      color: #2d2926;
      font-weight: bold;
    }
    
    /* Activity Log */
    .activity-log {
      /* Remove max-height and overflow to allow full expansion */
    }
    
    .activity-log-item {
      background: #f8f9fa;
      /* Remove green border */
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.4;
      border: 1px solid #e9ecef;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .activity-log-item.error {
      background: #fff3f3;
      border-color: #f5c6cb;
    }
    
    .activity-timestamp {
      color: #2d2926;
      font-size: 10px;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .activity-content {
      color: #2d2926;
    }
    
    /* Style the activity header */
    .activity-header {
      font-weight: 600;
      font-size: 16px;
      color: #2d2926;
      display: block;
      margin-bottom: 8px;
    }
    
    .activity-content ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
      list-style: none;
    }
    
    .activity-content li {
      position: relative;
      padding-left: 12px;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .activity-content li:before {
      content: "‚Ä¢";
      position: absolute;
      left: 0;
      color: #666;
    }
    
    .activity-content a {
      color: #c8102e;
      text-decoration: none;
      font-weight: 500;
    }
    
    .activity-content a:hover {
      text-decoration: underline;
    }
    
    .activity-content strong {
      color: #28a745;
    }
    
    .activity-log-item {
      position: relative;
    }
    
    .activity-main-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .activity-main-content:hover {
      background: rgba(0, 0, 0, 0.02);
      margin: 0 -12px;
      padding: 0 12px;
    }
    
    .activity-main-content:active {
      opacity: 0.8;
    }
    
    .activity-content-left {
      flex: 1;
    }
    
    .activity-raw-content {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin-top: 8px;
      max-height: 200px;
      overflow: auto;
      display: none;
      padding: 0;
    }
    
    .activity-raw-content pre {
      margin: 0;
      padding: 6px;
      font-size: 9px;
      line-height: 1.2;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    /* Mobile Actions */
    .actions-section {
      background: white;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .actions-header {
      background: #2d2926;
      color: white;
      padding: 12px 15px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .actions-count {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    
    .actions-grid {
      padding: 15px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    
    .mobile-action-btn {
      background: #2d2926;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-align: left;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .mobile-action-btn:hover:not(:disabled) {
      background: #1a1916;
      transform: translateY(-1px);
    }
    
    .mobile-action-btn:disabled {
      background: #dee2e6;
      cursor: not-allowed;
      transform: none;
    }
    
    .mobile-action-btn.loading {
      background: #f8f9fa;
      cursor: not-allowed;
      color: #2d2926;
      border: 1px solid #dee2e6;
    }
    
    .progress-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, 
        rgba(40, 167, 69, 0.2) 0%, 
        rgba(32, 201, 151, 0.3) 50%, 
        rgba(40, 167, 69, 0.2) 100%);
      z-index: 0;
      border-radius: 10px;
      pointer-events: none;
    }
    
    .mobile-action-btn.loading .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      right: -100px;
      width: 100px;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.4), 
        transparent);
      animation: shimmer 1.5s infinite;
    }
    
    .mobile-action-btn.completing .progress-fill::after {
      display: none;
    }
    
    @keyframes shimmer {
      0% { right: -100px; }
      100% { right: calc(100% + 100px); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.5; }
    }
    
    .mobile-action-btn .action-text,
    .mobile-action-btn .action-status {
      position: relative;
      z-index: 2;
    }
    
    .mobile-action-btn.completing {
      background: #28a745;
      cursor: not-allowed;
      opacity: 1 !important;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }
    
    .mobile-action-btn.completing .action-text {
      flex: 1;
      position: relative;
      z-index: 2;
    }
    
    .mobile-action-btn.completing .action-status {
      color: white;
      font-weight: bold;
      flex-shrink: 0;
      margin-left: 10px;
      position: relative;
      z-index: 2;
    }
    
    .mobile-action-btn.completing .progress-fill {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      z-index: 0;
    }
    
    .action-text {
      flex: 1;
      margin-right: 10px;
    }
    
    .action-status {
      font-size: 18px;
    }
    
    .mobile-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    
    
    
    
    /* Loading States */
    .loading-placeholder {
      text-align: center;
      padding: 20px;
      color: #2d2926;
      font-style: italic;
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .loading-dots {
      display: inline-block;
      margin-left: 5px;
    }
    
    .loading-dots::after {
      content: '';
      animation: loading-dots 1.5s infinite;
    }
    
    @keyframes loading-dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
    
    /* Responsive adjustments */
    @media (min-width: 480px) {
      .wo-quick-info {
        grid-template-columns: 1fr 1fr 1fr;
      }
      
      .actions-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .completed-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (min-width: 768px) {
      body {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      
      .actions-grid {
        grid-template-columns: 1fr 1fr 1fr;
      }
      
      .completed-grid {
        grid-template-columns: 1fr 1fr 1fr;
      }
      
      .wo-quick-info {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    /* Large phone landscape */
    @media (max-width: 812px) and (orientation: landscape) {
      .mobile-header {
        padding: 10px;
      }
      
      .mobile-header h1 {
        font-size: 18px;
        margin-bottom: 2px;
      }
      
      .mobile-header .subtitle {
        font-size: 12px;
      }
      
      .wo-card, .actions-section, .completed-section, .results-section {
        margin-bottom: 10px;
      }
    }
    
    /* Hidden sections */
    .hidden {
      display: none !important;
    }
    
    /* Refresh button styles */
    .nav-icon-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .nav-icon-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .nav-icon-button svg {
      transition: transform 0.2s ease;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Loading state styles */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      gap: 20px;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #c8102e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .loading-text {
      color: #666;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="nav">
        <h1>PartnerGPT</h1>
        <div class="nav-center">WO</div>
        <div class="nav-links">
          <button id="refreshWO" class="nav-icon-button" title="Generate New Work Order">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M1 4v6h6M23 20v-6h-6"/>
              <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
            </svg>
          </button>
          <a href="/partnerplus" class="nav-button">Chat</a>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">

  <div id="workOrderCard" class="wo-card hidden">
    <div class="wo-header" onclick="toggleWorkOrder()">
      <div>
        <div class="wo-title" id="woTitle">Work Order</div>
      </div>
      <div class="wo-toggle expanded" id="woToggle">‚ñº</div>
    </div>
    <div class="wo-content" id="woContent">
      <div class="wo-quick-info">
        <div class="wo-info-item">
          <div class="wo-info-label">Make</div>
          <div class="wo-info-value" id="woMake">Loading...</div>
        </div>
        <div class="wo-info-item">
          <div class="wo-info-label">Model</div>
          <div class="wo-info-value" id="woModel">Loading...</div>
        </div>
      </div>
      
      <!-- Location & Contact Section -->
      <div class="wo-section">
        <div class="wo-section-header">üìç Location & Contact</div>
        <div class="wo-section-content">
          <div class="wo-detail-item">
            <span class="wo-detail-label">Location:</span>
            <span id="woLocation">Loading...</span>
          </div>
          <div class="wo-detail-item">
            <span class="wo-detail-label">Contact:</span>
            <span id="woContact">Loading...</span>
          </div>
          <div class="wo-detail-item">
            <span class="wo-detail-label">Phone:</span>
            <span id="woPhone">Loading...</span>
          </div>
        </div>
      </div>
      
      <!-- Issue Details Section -->
      <div class="wo-section">
        <div class="wo-section-header">üìã Issue Details</div>
        <div class="wo-section-content">
          <div class="wo-detail-item">
            <span class="wo-detail-label">Description:</span>
            <div id="woIssue" style="margin-top: 5px;">Loading...</div>
          </div>
        </div>
      </div>
      
      <div class="wo-section" id="activityLogSection" style="display: none;">
        <div class="wo-section-header">üìù Activity Log</div>
        <div class="wo-section-content">
          <div id="activityLog" class="activity-log"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="actionsSection" class="actions-section hidden">
    <div class="actions-header">
      <span>Recommended Actions</span>
      <span class="actions-count" id="actionsCount">0</span>
    </div>
    <div class="actions-grid" id="actionsGrid">
      <div class="loading-placeholder">
        Generating recommendations<span class="loading-dots"></span>
      </div>
    </div>
  </div>


  <script>
    let currentWorkOrder = null;
    let actionResults = [];

    // Auto-generate work order on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('DOMContentLoaded - starting work order generation');
      generateRandomWorkOrder();
    });
    
    // Handle refresh button
    document.getElementById('refreshWO').addEventListener('click', function() {
      const button = this;
      button.disabled = true;
      
      // Reset all data
      currentWorkOrder = null;
      actionResults = [];
      resetSections();
      
      // Generate new work order
      generateRandomWorkOrder();
      
      // Re-enable button after a short delay
      setTimeout(() => {
        button.disabled = false;
      }, 500);
    });

    function toggleWorkOrder() {
      const content = document.getElementById('woContent');
      const toggle = document.getElementById('woToggle');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.classList.add('expanded');
      } else {
        content.style.display = 'none';
        toggle.classList.remove('expanded');
      }
    }

    async function generateRandomWorkOrder() {
      console.log('generateRandomWorkOrder called');
      // Show loading state in work order card  
      const workOrderCard = document.getElementById('workOrderCard');
      workOrderCard.classList.remove('hidden');
      
      // Show loading content
      document.getElementById('woContent').innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <div class="loading-text">Generating work order...</div>
        </div>
      `;

      // Reset other sections but keep WO card visible
      resetSections();

      try {
        const response = await fetch('/api/generate-work-order');
        console.log('Work order response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const workOrder = await response.json();
        console.log('Work order data:', workOrder);
        
        currentWorkOrder = workOrder;
        displayWorkOrder(workOrder);
        
        // Work order is already expanded by default

        // Generate action recommendations
        setTimeout(() => generateActionRecommendations(), 1000);
        
      } catch (error) {
        console.error('Error generating work order:', error);
        document.getElementById('woContent').innerHTML = `
          <div style="text-align: center; padding: 20px; color: #dc3545;">
            Failed to generate work order: ${error.message}<br>
            Please try again.
          </div>
        `;
      }
    }

    function resetSections() {
      // Work order stays visible and expanded
      
      // Reset actions
      const actionsSection = document.getElementById('actionsSection');
      if (actionsSection) {
        actionsSection.classList.add('hidden');
      }
      
      const actionsGrid = document.getElementById('actionsGrid');
      if (actionsGrid) {
        actionsGrid.innerHTML = '<div class="loading-placeholder">Generating recommendations<span class="loading-dots"></span></div>';
      }
      
      // Reset activity log
      const activityLogSection = document.getElementById('activityLogSection');
      if (activityLogSection) {
        activityLogSection.style.display = 'none';
      }
      
      const activityLog = document.getElementById('activityLog');
      if (activityLog) {
        activityLog.innerHTML = '';
      }
      
      // Reset data
      actionResults = [];
      
      // Only call updateCounts if the function exists
      if (typeof updateCounts === 'function') {
        updateCounts();
      }
    }

    function displayWorkOrder(workOrder) {
      console.log('displayWorkOrder called with:', workOrder);
      // Restore the work order content structure
      document.getElementById('woContent').innerHTML = `
        <div class="wo-quick-info">
          <div class="wo-info-item">
            <div class="wo-info-label">Make</div>
            <div class="wo-info-value" id="woMake">Loading...</div>
          </div>
          <div class="wo-info-item">
            <div class="wo-info-label">Model</div>
            <div class="wo-info-value" id="woModel">Loading...</div>
          </div>
        </div>
        <div class="wo-section">
          <div class="wo-section-header">üìç Restaurant Details</div>
          <div class="wo-section-content">
            <div class="wo-detail-item">
              <span class="wo-detail-label">Location:</span>
              <span id="woLocation">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Address:</span>
              <span id="woAddress">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Contact:</span>
              <span id="woContact">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Phone:</span>
              <span id="woPhone">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Email:</span>
              <span id="woEmail">Loading...</span>
            </div>
          </div>
        </div>
        <div class="wo-section">
          <div class="wo-section-header">üîß Technician Details</div>
          <div class="wo-section-content">
            <div class="wo-detail-item">
              <span class="wo-detail-label">Name:</span>
              <span id="techName">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Phone:</span>
              <span id="techPhone">Loading...</span>
            </div>
            <div class="wo-detail-item">
              <span class="wo-detail-label">Email:</span>
              <span id="techEmail">Loading...</span>
            </div>
          </div>
        </div>
        <div class="wo-section">
          <div class="wo-section-header">üìã Issue Details</div>
          <div class="wo-section-content">
            <div class="issue-details-item">
              <span class="wo-detail-label">Dispatch Notes:</span>
              <span id="woDispatchNotes">Loading...</span>
            </div>
            <div class="issue-details-item">
              <span class="wo-detail-label">Tech Notes:</span>
              <span id="woTechNotes">Loading...</span>
            </div>
            <div class="issue-details-item">
              <span class="wo-detail-label">Suspected Parts:</span>
              <span id="woSuspectedParts">Loading...</span>
            </div>
          </div>
        </div>
        <div class="wo-section" id="activityLogSection" style="display: none;">
          <div class="wo-section-header">üìù Activity Log</div>
          <div class="wo-section-content">
            <div id="activityLog" class="activity-log"></div>
          </div>
        </div>
      `;
      
      // Header info
      document.getElementById('woTitle').textContent = workOrder.id;
      
      // Quick info section - smart split for multi-word brands
      const multiWordBrands = [
        'Henny Penny', 'American Range', 'True Manufacturing', 'Turbo Air', 
        'Master-Bilt', 'Robot Coupe', 'Waring Commercial', 'Electrolux Professional',
        'Rational AG', 'Ice-O-Matic', 'Manitowoc Ice', 'Taylor Company',
        'Beverage-Air', 'Alto-Shaam', 'APW Wyott'
      ];
      
      let make = '';
      let model = '';
      
      // Check if equipment starts with a multi-word brand
      const equipmentLower = workOrder.equipment.toLowerCase();
      const foundBrand = multiWordBrands.find(brand => 
        equipmentLower.startsWith(brand.toLowerCase())
      );
      
      if (foundBrand) {
        make = foundBrand;
        model = workOrder.equipment.substring(foundBrand.length).trim();
      } else {
        // Default to first word as make
        const equipmentParts = workOrder.equipment.split(' ');
        make = equipmentParts[0];
        model = equipmentParts.slice(1).join(' ');
      }
      
      document.getElementById('woMake').textContent = make;
      document.getElementById('woModel').textContent = model;
      
      // Location & Contact section
      document.getElementById('woLocation').textContent = workOrder.locationName || workOrder.customer || 'N/A';
      document.getElementById('woAddress').textContent = workOrder.address || 'N/A';
      document.getElementById('woContact').textContent = workOrder.locationContactName || workOrder.contact || 'N/A';
      document.getElementById('woPhone').textContent = workOrder.locationContactPhone || 'N/A';
      document.getElementById('woEmail').textContent = workOrder.locationContactEmail || 'N/A';
      
      // Technician section
      document.getElementById('techName').textContent = workOrder.technicianName || workOrder.technician || 'N/A';
      document.getElementById('techPhone').textContent = workOrder.technicianPhone || 'N/A';
      document.getElementById('techEmail').textContent = workOrder.technicianEmail || 'N/A';
      
      // Issue Details section - format bullet points
      const formatBulletPoints = (text) => {
        if (!text) return 'No notes available';
        // Split by bullet points and wrap in list
        const bullets = text.split('‚Ä¢').filter(b => b.trim());
        if (bullets.length > 1) {
          return '<ul style="margin: 0; padding-left: 20px;">' + 
                 bullets.map(b => `<li>${b.trim()}</li>`).join('') + 
                 '</ul>';
        }
        return text;
      };
      
      document.getElementById('woDispatchNotes').innerHTML = formatBulletPoints(workOrder.dispatchNotes || workOrder.description);
      document.getElementById('woTechNotes').innerHTML = formatBulletPoints(workOrder.serviceNotes);
      document.getElementById('woSuspectedParts').textContent = workOrder.suspectedParts ? workOrder.suspectedParts.join(', ') : 'No parts identified';
      
      document.getElementById('workOrderCard').classList.remove('hidden');
    }

    // New 1-in-1-out replacement queue to handle concurrent completions
    let replacementQueue = [];
    let isProcessingReplacements = false;
    
    async function generateSingleReplacementAction() {
      // Add to queue
      replacementQueue.push(Date.now());
      
      // Process queue if not already processing
      if (!isProcessingReplacements) {
        processReplacementQueue();
      }
    }
    
    async function processReplacementQueue() {
      if (isProcessingReplacements || replacementQueue.length === 0) {
        return;
      }
      
      isProcessingReplacements = true;
      
      while (replacementQueue.length > 0) {
        replacementQueue.shift(); // Remove from queue
        
        // Check if we still need a replacement
        const currentGap = getCurrentActionGap();
        if (currentGap > 0) {
          await generateActionRecommendations(true, true); // Generate exactly 1 action
          // Small delay to prevent API rate limiting
          await new Promise(resolve => setTimeout(resolve, 500));
        }
      }
      
      isProcessingReplacements = false;
    }
    
    async function generateActionRecommendations(isFollowUp = false, singleReplacement = false) {
      document.getElementById('actionsSection').classList.remove('hidden');
      
      try {
        // Get activity log context for follow-up actions
        const activityContext = getActivityLogContext();
        const activityContextText = activityContext.length > 0 ? `

=== COMPLETED ACTIONS & CUMULATIVE INTELLIGENCE ===
${activityContext.map((item) => `
ACTION ${item.actionNumber}: [${item.timestamp}]
SUMMARY: ${item.summary}
COMPLETE RAW API RESPONSE:
${item.rawData}
---
`).join('')}

=== CUMULATIVE CONTEXT ANALYSIS ===
Total Actions Completed: ${activityContext.length}
Knowledge Base: All raw API responses above contain the complete discovered information including:
- Exact part numbers, prices, availability
- Supplier contact details, addresses, phone numbers
- Manual links, technical specifications, troubleshooting steps
- Service provider locations, ratings, contact information
- Previous communication records and customer interactions

CRITICAL: Analyze the completed actions above and their detailed API responses to generate INTELLIGENT NEXT STEPS that:
- Use specific part numbers, supplier info, prices, and contact details found in the raw data
- Reference specific manual pages, error codes, or technical details discovered
- Build logically on what was already accomplished (don't repeat completed work)
- Progress the repair workflow toward resolution` : '';

        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `You're managing work order for: ${currentWorkOrder.equipment} with issue: ${currentWorkOrder.dispatchNotes || currentWorkOrder.description || 'service issue'}

${activityContextText ? `Previous data retrieved shown above. Review what information has already been gathered.` : ''}

Generate ${isFollowUp ? (singleReplacement ? '1' : getCurrentActionGap()) : '4'} data retrieval actions.

CRITICAL: Each action must be something the system can EXECUTE to retrieve data:
‚úì "Resolve evaporator motor OEM part number" - System finds part number
‚úì "Download service manual for KM-150BAH" - System retrieves manual
‚úì "Search troubleshooting for grinding noise" - System finds solutions
‚úì "Find suppliers for part 2A-3847-05" - System gets supplier list
‚úì "Email customer repair timeline update" - System sends email
‚úì "Text technician parts availability" - System sends SMS update
‚úì "Email customer cost estimate" - System sends pricing email

‚úó "Check water pressure at inlet" - Requires physical presence
‚úó "Inspect evaporator for damage" - Requires technician onsite
‚úó "Review maintenance records" - Too vague, no API endpoint
‚úó "Locate part numbers inside unit" - Requires physical inspection

IMPORTANT: Include at least 1 communication action (email/text) every 3-4 actions to keep all parties informed.

Focus on ${currentWorkOrder.suspectedParts ? `these suspected parts: ${currentWorkOrder.suspectedParts.join(', ')}` : 'identifying needed parts'}.

${isFollowUp ? 
  activityContext?.some(item => item.rawData?.includes('part_number') || item.rawData?.includes('similar_parts')) ?
    `Part numbers found. Mix: supplier searches, price checks, AND communication (email ETA, text tech updates).` :
    `No parts identified yet. Mix: part resolution, manuals, AND communication (email status update, text questions).`
  : 
  `Start with: resolve parts, get manual, research symptoms, AND send initial customer email update.`
}

Remember: Balance technical actions with communication. Include emails/texts to customer and technician.
Output only executable data retrieval actions, one per line.`
          })
        });

        const data = await response.json();
        const actionsText = data.response;
        
        // Parse actions from AI response (now async)
        const actions = await parseActionsFromText(actionsText);
        
        if (isFollowUp) {
          // Append to existing actions
          appendMobileActions(actions);
        } else {
          // Replace all actions
          displayMobileActions(actions);
        }
        
      } catch (error) {
        console.error('Error generating actions:', error);
        if (!isFollowUp) {
          document.getElementById('actionsGrid').innerHTML = '<div class="loading-placeholder">Failed to generate actions</div>';
        }
      }
    }

    async function parseActionsFromText(text) {
      const lines = text.split('\n').filter(line => line.trim());
      const actions = [];
      
      const seenActions = new Set(); // Track unique actions
      
      for (const line of lines) {
        // Clean up markdown formatting, arrows, and other unwanted characters
        const cleanLine = line
          .replace(/^\d+\.?\s*|\*\s*|-\s*/g, '') // Remove bullets and numbers
          .replace(/^‚ñ∂\s*/g, '') // Remove arrow markers
          .replace(/^\>\s*/g, '') // Remove quote markers
          .replace(/^Here are.*actions?:?/i, '') // Remove intro text
          .replace(/^for the work order:?/i, '') // Remove "for the work order" text
          .replace(/Would you like.*$/i, '') // Remove questions
          .replace(/If you'd like to proceed.*$/i, '') // Remove outro text
          .replace(/^\*\*(.+)\*\*$/, '$1') // Remove bold markdown
          .trim();
          
        // Check for duplicates using normalized comparison
        const normalizedLine = cleanLine.toLowerCase().replace(/[^a-z0-9]/g, '');
        
        if (cleanLine && 
            cleanLine.length > 10 && 
            !cleanLine.match(/^(Here|If|Would|for the|Let me)/i) &&
            !cleanLine.includes('?') &&
            !seenActions.has(normalizedLine)) {  // Exclude duplicates
          // Smart action classification - let AI understand intent
          const type = await intelligentlyClassifyAction(cleanLine);
          
          seenActions.add(normalizedLine); // Mark as seen
          actions.push({
            name: cleanLine,
            type: type
          });
        }
      }
      
      return actions.slice(0, 8); // Limit to 8 actions
    }
    
    async function intelligentlyClassifyAction(actionText) {
      // Simple keyword check first for obvious cases (faster)
      const lower = actionText.toLowerCase();
      
      if (lower.includes('email')) return 'email';
      if (lower.includes('text') || lower.includes('sms')) return 'sms';
      if (lower.includes('manual') || lower.includes('documentation')) return 'manual_search';
      if (lower.includes('resolve') && lower.includes('oem')) return 'parts_search';
      if (lower.includes('price') || lower.includes('supplier')) return 'supplier_search';
      if (lower.includes('service provider') || lower.includes('repair shop')) return 'service_search';
      
      // For ambiguous cases, use AI
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `What type of service action is this: "${actionText}"?

Choose one:
- parts (finding part numbers)
- suppliers (comparing prices/suppliers)  
- manual (technical docs)
- web (research/troubleshooting)
- service (repair shops)
- email/sms (communication)
- general (other)

Respond with just the type.`
          })
        });
        const data = await response.json();
        const type = data.response?.toLowerCase().trim();
        
        // Map to our internal types
        if (type?.includes('parts')) return 'parts_search';
        if (type?.includes('supplier')) return 'supplier_search';
        if (type?.includes('manual')) return 'manual_search';
        if (type?.includes('web')) return 'web_search';
        if (type?.includes('service')) return 'service_search';
        if (type?.includes('email')) return 'email';
        if (type?.includes('sms')) return 'sms';
        
        return 'general';
      } catch (error) {
        console.error('Classification failed:', error);
        return 'general';
      }
    }

    function displayMobileActions(actions) {
      const actionsGrid = document.getElementById('actionsGrid');
      actionsGrid.innerHTML = '';
      
      actions.forEach((action, index) => {
        const button = document.createElement('button');
        button.className = 'mobile-action-btn';
        button.innerHTML = `
          <div class="action-text">${action.name}</div>
          <div class="action-status">‚ñ∂</div>
        `;
        button.onclick = () => executeAction(action, button, index);
        actionsGrid.appendChild(button);
      });
      
      updateCounts();
    }
    
    function appendMobileActions(actions) {
      const actionsGrid = document.getElementById('actionsGrid');
      
      actions.forEach((action, index) => {
        const button = document.createElement('button');
        button.className = 'mobile-action-btn';
        button.innerHTML = `
          <div class="action-text">${action.name}</div>
          <div class="action-status">‚ñ∂</div>
        `;
        button.onclick = () => executeAction(action, button, index);
        actionsGrid.appendChild(button);
      });
      
      updateCounts();
    }

    // Timing service for realistic loading animations
    function getExpectedLoadTime(actionType, actionName) {
      // Base times in milliseconds (doubled for safety buffer)
      const timings = {
        part_resolution: { min: 20000, max: 40000 },  // 20-40s
        parts_search: { min: 20000, max: 40000 },     // 20-40s
        manual_search: { min: 30000, max: 60000 },    // 30-60s
        supplier_search: { min: 4000, max: 10000 },   // 4-10s
        service_search: { min: 6000, max: 12000 },    // 6-12s
        email: { min: 2000, max: 4000 },              // 2-4s
        sms: { min: 2000, max: 4000 },                // 2-4s
        troubleshooting_search: { min: 16000, max: 30000 }, // 16-30s
        general: { min: 4000, max: 8000 }             // 4-8s
      };
      
      // Get timing for this action type
      let timing = timings[actionType] || timings.general;
      
      // Adjust for specific keywords in action name
      const lowerName = actionName.toLowerCase();
      if (lowerName.includes('resolve') || lowerName.includes('oem')) {
        // Part resolution takes longer
        timing = timings.part_resolution;
      } else if (lowerName.includes('troubleshoot')) {
        timing = timings.troubleshooting_search;
      }
      
      // Return random time within range
      return timing.min + Math.random() * (timing.max - timing.min);
    }
    
    function animateProgressBar(button, duration) {
      // Create progress fill element and insert it as first child
      const progressFill = document.createElement('div');
      progressFill.className = 'progress-fill';
      button.insertBefore(progressFill, button.firstChild);
      
      // Use requestAnimationFrame for smooth animation
      const startTime = Date.now();
      const maxProgress = 85; // Stop at 85% to leave room
      let animationId;
      
      function updateProgress() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Use easing function for more realistic feel
        const easedProgress = easeOutQuart(progress) * maxProgress;
        progressFill.style.width = `${easedProgress}%`;
        
        if (progress < 1) {
          animationId = requestAnimationFrame(updateProgress);
        }
      }
      
      animationId = requestAnimationFrame(updateProgress);
      
      return { 
        stop: () => cancelAnimationFrame(animationId), 
        progressFill 
      };
    }
    
    function easeOutQuart(t) {
      return 1 - Math.pow(1 - t, 4);
    }
    
    async function executeAction(action, button, actionIndex) {
      button.classList.add('loading');
      button.disabled = true;
      
      // Start loading animation with expected duration
      const expectedTime = getExpectedLoadTime(action.type, action.name);
      const progressAnimation = animateProgressBar(button, expectedTime);
      const progressFill = progressAnimation.progressFill;
      
      // Update status to spinning indicator
      button.querySelector('.action-status').innerHTML = '<div class="mobile-spinner"></div>';

      try {
        // Generate action parameters (now async)
        const actionConfig = await generateActionConfig(action.type, action.name);
        
        let url = actionConfig.endpoint;
        let requestBody = null;
        
        if (actionConfig.method === 'GET') {
          const params = new URLSearchParams(actionConfig.params);
          url += '?' + params.toString();
        } else {
          requestBody = JSON.stringify(actionConfig.params);
        }

        const startTime = Date.now();
        const response = await fetch(url, {
          method: actionConfig.method,
          headers: actionConfig.method === 'POST' ? { 'Content-Type': 'application/json' } : {},
          body: requestBody
        });

        const result = await response.json();
        
        // Ensure minimum animation time for smooth UX
        const elapsed = Date.now() - startTime;
        const minTime = Math.min(expectedTime * 0.3, 2000); // At least 30% of expected or 2s
        if (elapsed < minTime) {
          await new Promise(resolve => setTimeout(resolve, minTime - elapsed));
        }
        
        // Complete the progress bar to 100%
        progressAnimation.stop();
        if (progressFill) {
          progressFill.style.transition = 'width 0.3s ease';
          progressFill.style.width = '100%';
        }
        
        // Brief pause before completing
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Move to completed (this will log the activity)
        await moveToCompleted(button, action, result);
        
      } catch (error) {
        console.error('Error executing action:', error);
        progressAnimation.stop();
        const errorResult = { error: error.message };
        await moveToCompleted(button, action, errorResult);
      }
    }

    async function generateActionConfig(actionType, actionName) {
      const zipMatch = currentWorkOrder.address?.match(/\b\d{5}\b/);
      const zipCode = zipMatch ? zipMatch[0] : "12345";
      
      // Smart split for multi-word brands
      const multiWordBrands = [
        'Henny Penny', 'American Range', 'True Manufacturing', 'Turbo Air', 
        'Master-Bilt', 'Robot Coupe', 'Waring Commercial', 'Electrolux Professional',
        'Rational AG', 'Ice-O-Matic', 'Manitowoc Ice', 'Taylor Company',
        'Beverage-Air', 'Alto-Shaam', 'APW Wyott'
      ];
      
      const equipmentLower = currentWorkOrder.equipment.toLowerCase();
      const foundBrand = multiWordBrands.find(brand => 
        equipmentLower.startsWith(brand.toLowerCase())
      );
      
      const make = foundBrand || currentWorkOrder.equipment.split(' ')[0] || "Unknown";

      const configs = {
        parts_search: {
          endpoint: '/api/purchase-agent/parts/resolve',
          method: 'POST',
          params: {
            description: extractPartFromAction(actionName),
            make: make,
            model: currentWorkOrder.equipment
          }
        },
        supplier_search: async () => {
          // Extract part number and validate it exists
          const partNumber = await intelligentlyExtractPart(actionName);
          
          // Check if we have a valid part number (not generic)
          if (!partNumber || partNumber === 'general part' || partNumber === 'replacement part' || 
              partNumber.length < 3 || !partNumber.match(/[0-9]/) || partNumber === 'unknown') {
            // No valid part number - return error config
            return {
              endpoint: '/api/chat',
              method: 'POST',
              params: {
                message: `Cannot search for suppliers without a specific part number. Please resolve the OEM part number first for ${currentWorkOrder.equipment}.`
              }
            };
          }
          
          return {
            endpoint: '/api/purchase-agent/suppliers/search',
            method: 'POST',
            params: {
              partNumber: partNumber,  // Changed from part_number to partNumber to match Node.js API
              options: {
                make: make,
                limit: 5
              }
            }
          };
        },
        service_search: {
          endpoint: '/api/purchase-agent/service-search',  // Fixed endpoint path
          method: 'POST',  // Changed from GET to POST to match Node.js API
          params: {
            zipCode: zipCode,
            make: make
          }
        },
        manual_search: {
          endpoint: '/api/purchase-agent/manuals/search',
          method: 'GET',
          params: {
            make: make,
            model: currentWorkOrder.equipment.split(' ').slice(1).join(' ') || 'Unknown'
          }
        },
        web_search: {
          endpoint: '/api/purchase-agent/search/web',
          method: 'POST',
          params: {
            query: `${currentWorkOrder.equipment} ${extractPartFromAction(actionName)} repair troubleshooting`
          }
        },
        email: {
          endpoint: '/api/email/send',
          method: 'POST',
          params: {
            to: currentWorkOrder.locationContactEmail || 'customer@example.com',
            subject: `Work Order #${currentWorkOrder.id} - Service Update`,
            text: generateEmailContent(actionName, currentWorkOrder)
          }
        },
        sms: {
          endpoint: '/api/sms/send',
          method: 'POST',
          params: {
            to: formatPhoneNumber(currentWorkOrder.technicianPhone || currentWorkOrder.locationContactPhone),
            message: `WO #${currentWorkOrder.id}: ${actionName}`
          }
        },
        orchestrator: {
          endpoint: '/api/orchestrator/objective',
          method: 'POST',
          params: {
            objective: `${actionName} for ${currentWorkOrder.equipment} at ${currentWorkOrder.customer}`
          }
        },
        general: {
          endpoint: '/api/chat',
          method: 'POST',
          params: {
            message: `Help me with this work order task: ${actionName}. Context: ${currentWorkOrder.equipment} - ${currentWorkOrder.dispatchNotes || currentWorkOrder.description}`
          }
        }
      };

      // Handle async supplier_search function
      if (actionType === 'supplier_search') {
        return await configs.supplier_search();
      }
      
      return configs[actionType] || configs.general;
    }

    function extractPartFromAction(actionName) {
      const lowerAction = actionName.toLowerCase();
      const partKeywords = ['part', 'component', 'seal', 'gasket', 'motor', 'pump', 'valve', 'belt', 'filter', 'element'];
      
      for (const keyword of partKeywords) {
        if (lowerAction.includes(keyword)) {
          const words = actionName.split(' ');
          const keywordIndex = words.findIndex(word => word.toLowerCase().includes(keyword));
          if (keywordIndex >= 0) {
            return words.slice(Math.max(0, keywordIndex - 1), keywordIndex + 2).join(' ');
          }
        }
      }
      
      return actionName.split(' ').slice(0, 3).join(' ');
    }

    async function intelligentlyExtractPart(actionText) {
      // First check activity log for discovered part numbers
      const activityItems = document.querySelectorAll('.activity-raw-content pre');
      let discoveredParts = [];
      
      activityItems.forEach(item => {
        const content = item.textContent;
        // Look for part numbers in previous results
        const partMatches = content.match(/"part_number":\s*"([^"]+)"/g);
        if (partMatches) {
          partMatches.forEach(match => {
            const part = match.match(/"([^"]+)"$/)?.[1];
            if (part && part !== 'null' && part !== 'None') {
              discoveredParts.push(part);
            }
          });
        }
        // Check recommended_result for part numbers
        const recommendedMatch = content.match(/"recommended_result".*?"part_number":\s*"([^"]+)"/g);
        if (recommendedMatch) {
          recommendedMatch.forEach(match => {
            const part = match.match(/"([^"]+)"$/)?.[1];
            if (part && part !== 'null' && part !== 'None') {
              discoveredParts.push(part);
            }
          });
        }
        
        // Also check similar_parts
        const similarMatches = content.match(/"similar_parts".*?"part_number":\s*"([^"]+)"/g);
        if (similarMatches) {
          similarMatches.forEach(match => {
            const part = match.match(/"([^"]+)"$/)?.[1];
            if (part) discoveredParts.push(part);
          });
        }
      });
      
      // First try to extract part number directly from action text
      // Match patterns like "for part 765071196" or "part 4A5096-01"
      const directPartMatch = actionText.match(/(?:for\s+part|part)\s+([A-Z0-9][A-Z0-9-]+)/i);
      if (directPartMatch && directPartMatch[1]) {
        console.log('Found part in action text:', directPartMatch[1]);
        return directPartMatch[1];
      }
      
      // Try simple pattern matching for common part formats
      const partPatterns = [
        /\b([0-9]{6,10})\b/,  // 765071196
        /\b([0-9A-Z]{2}[0-9]{4}-[0-9]{2})\b/,  // 4A5096-01
        /\b([0-9]{5}[A-Z])\b/,  // 45764A
        /\b([0-9]{2}-[0-9]{6})\b/  // 00-426635
      ];
      
      for (const pattern of partPatterns) {
        const match = actionText.match(pattern);
        if (match) {
          console.log('Pattern matched part:', match[1]);
          return match[1];
        }
      }
      
      // If we found parts in history, try to match with action text
      if (discoveredParts.length > 0) {
        console.log('Discovered parts from history:', discoveredParts);
        for (const part of discoveredParts) {
          if (actionText.includes(part)) {
            console.log('Matched part from history:', part);
            return part;
          }
        }
        // If action doesn't specify, use most recent discovered part
        if (actionText.toLowerCase().includes('price') || actionText.toLowerCase().includes('supplier')) {
          console.log('Using most recent part:', discoveredParts[discoveredParts.length - 1]);
          return discoveredParts[discoveredParts.length - 1];
        }
      }
      
      // Let AI extract from action text
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `Extract the part number from: "${actionText}"

Look for specific part numbers like 45764A, 00-426635, etc.
If no specific part number is mentioned, return "unknown".

Respond with only the part number or "unknown".`
          })
        });
        const data = await response.json();
        const part = data.response?.trim();
        
        if (part && part !== 'unknown' && part !== 'general part') {
          return part;
        }
      } catch (error) {
        console.error('Part extraction failed:', error);
      }
      
      return 'unknown';
    }
    
    function extractPartFromAction(actionName) {
      // Keep simple version for non-async uses
      const lower = actionName.toLowerCase();
      if (lower.includes('thermostat')) return 'thermostat';
      if (lower.includes('element')) return 'heating element';
      if (lower.includes('board')) return 'control board';
      if (lower.includes('sensor')) return 'sensor';
      return actionName.split(' ').slice(0, 3).join(' ');
    }

    function formatPhoneNumber(phone) {
      if (!phone) return '+15024456053'; // Default fallback
      
      // Remove all non-digits
      const cleaned = phone.replace(/\D/g, '');
      
      // Handle different formats
      if (cleaned.length === 10) {
        return `+1${cleaned}`;
      } else if (cleaned.length === 11 && cleaned.startsWith('1')) {
        return `+${cleaned}`;
      } else if (cleaned.length === 11) {
        return `+1${cleaned.slice(1)}`;
      }
      
      return `+1${cleaned.slice(-10)}`; // Take last 10 digits
    }

    function generateEmailContent(actionName, workOrder) {
      const customerName = workOrder.locationContactName || 'Valued Customer';
      const equipment = workOrder.equipment || 'equipment';
      const issue = workOrder.dispatchNotes || workOrder.description || 'service issue';
      
      if (actionName.toLowerCase().includes('status update')) {
        return `Dear ${customerName},

This is an update regarding your service request for the ${equipment} at ${workOrder.address || 'your location'}.

Issue: ${issue}
Technician: ${workOrder.technicianName || 'Our service team'}
Status: Work in progress

We will keep you informed of any developments.

Best regards,
PartnerGPT Service Team`;
      } else if (actionName.toLowerCase().includes('parts')) {
        return `Dear ${customerName},

We have identified the parts needed for your ${equipment} repair:

Issue: ${issue}
Required parts are being sourced and will be ordered shortly.

We will contact you with delivery timeframes and next steps.

Best regards,
PartnerGPT Service Team`;
      } else {
        return `Dear ${customerName},

Regarding your service request for ${equipment}:

${actionName}

We will keep you updated on progress.

Best regards,
PartnerGPT Service Team`;
      }
    }

    function extractPhoneFromContact(contact) {
      const phoneMatch = contact.match(/\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/);
      return phoneMatch ? phoneMatch[0].replace(/\D/g, '').replace(/^(\d{3})(\d{3})(\d{4})$/, '+1$1$2$3') : '+15024456053';
    }

    async function logActivity(action, result) {
      try {
        // Generate formatted log entry
        const logEntry = await generateActivityLogEntry(action, result);
        
        // Show activity log section
        const activitySection = document.getElementById('activityLogSection');
        if (activitySection) {
          activitySection.style.display = 'block';
        } else {
          console.error('Activity log section not found!');
          return;
        }
        
        // Create log item
        const logItem = document.createElement('div');
        logItem.className = `activity-log-item ${result.error ? 'error' : ''}`;
        
        const timestamp = new Date().toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        });
        
        const rawToggleId = `raw-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        logItem.innerHTML = `
          <div class="activity-timestamp">${timestamp}</div>
          <div class="activity-main-content" onclick="toggleActivityRaw('${rawToggleId}')">
            <div class="activity-content-left">
              <div class="activity-content">${logEntry}</div>
            </div>
          </div>
          <div id="${rawToggleId}" class="activity-raw-content">
            <pre>${JSON.stringify(result, null, 2)}</pre>
          </div>
        `;
        
        // Add to log (newest at bottom)
        const activityLog = document.getElementById('activityLog');
        if (activityLog) {
          activityLog.appendChild(logItem);
        } else {
          console.error('Activity log container not found!');
        }
        
        // Store result
        actionResults.push({ action, result, timestamp: Date.now() });
      } catch (error) {
        console.error('Failed to log activity:', error);
      }
    }

    async function moveToCompleted(button, action, result) {
      // Remove loading state
      button.classList.remove('loading');
      
      // Update progress bar for completing state
      const progressFill = button.querySelector('.progress-fill');
      if (progressFill) {
        progressFill.style.transition = 'all 0.3s ease';
        progressFill.style.width = '100%';
        progressFill.style.background = 'rgba(255, 255, 255, 0.1)';
        progressFill.style.animation = 'none';
        // Remove shimmer
        const shimmer = progressFill.querySelector('::after');
        if (shimmer) {
          progressFill.style.setProperty('--shimmer-display', 'none');
        }
      }
      
      // Show completing state
      button.classList.add('completing');
      button.querySelector('.action-status').innerHTML = '‚úì';
      button.querySelector('.action-text').style.opacity = '0.9';
      
      // Log the activity
      await logActivity(action, result);
      
      // Fade out the button
      button.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
      button.style.opacity = '0';
      button.style.transform = 'scale(0.95)';
      
      // Remove button after animation
      setTimeout(() => {
        button.remove();
        updateCounts();
        
        // Auto-generate follow-up actions immediately when less than 4 actions remain
        const actionGap = getCurrentActionGap();
        if (actionGap > 0) { // Only generate if we need actions to reach exactly 4
          // Use 1-in-1-out system - generate exactly one replacement
          generateSingleReplacementAction();
        }
      }, 300);
    }

    async function generateActivityLogEntry(action, result) {
      try {
        const prompt = `Create a structured activity log entry for this work order action.

Action: ${action.name}
Result: ${JSON.stringify(result, null, 2)}

CRITICAL FORMATTING RULES:
1. Create a SHORT HEADER (max 4-6 words) that summarizes the action
2. Use one of these header patterns based on action type:
   - Parts: "[Part Type] Part Number [Number]"
   - Manuals: "Technical Manual [Make] [Model]"  
   - Suppliers: "[Part Name] [Number] Supplier"
   - Communications: "Emailed/Called [Name] [Topic]"
   - Equipment Images: "Equipment Photo [Make] [Model]"
   - Part Images: "[Part Type] Image [Number]"
   - Service Providers: "Service Provider [Company]"
   - Errors: "Error: [Brief Description]"
3. List relevant links/details below the header as bullet points
4. Keep headers VERY concise - no full sentences
5. Format links as <a href="url" target="_blank">Link Text</a>

EXAMPLES:
Header: Technical Manual Hobart AM15
‚Ä¢ <a href="manual1.pdf" target="_blank">Installation Manual</a>
‚Ä¢ <a href="manual2.pdf" target="_blank">Parts Manual</a>

Header: Door Seal Part 00-875643
‚Ä¢ Price: $45.99
‚Ä¢ Stock: 12 available
‚Ä¢ <a href="supplier.com/part" target="_blank">Order from Parts Town</a>

Header: Emailed John Smith Update
‚Ä¢ Status: Awaiting parts delivery
‚Ä¢ ETA: Tomorrow 2PM

Header: Heating Element 426635 Supplier
‚Ä¢ <a href="supplier1.com" target="_blank">WebstaurantStore - $89.99</a>
‚Ä¢ <a href="supplier2.com" target="_blank">Parts Town - $92.50</a>

IMPORTANT: Structure your response EXACTLY like this:
<div class="activity-header">[Your Header Here]</div>
<ul>
<li>[First bullet point]</li>
<li>[Second bullet point if needed]</li>
<li>[Third bullet point if needed]</li>
</ul>

Return ONLY the formatted HTML entry. No additional text.`;

        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: prompt })
        });

        const data = await response.json();
        return data.response || 'Action completed';
      } catch (error) {
        console.error('Activity log generation failed:', error);
        return `${action.type === 'error' ? '‚ùå' : '‚úÖ'} ${action.name}`;
      }
    }


    function toggleActivityRaw(toggleId) {
      const rawContent = document.getElementById(toggleId);
      const isHidden = rawContent.style.display === 'none' || !rawContent.style.display;
      rawContent.style.display = isHidden ? 'block' : 'none';
    }

    function updateCounts() {
      const activeActions = document.querySelectorAll('.mobile-action-btn').length;
      document.getElementById('actionsCount').textContent = activeActions;
    }
    
    function getCurrentActionGap() {
      const currentCount = document.querySelectorAll('.mobile-action-btn').length;
      const targetCount = 4;
      const gap = targetCount - currentCount;
      return Math.max(0, gap); // Only generate what's needed to reach exactly 4, never exceed
    }
    
    function getActivityLogContext() {
      const activityItems = document.querySelectorAll('.activity-log-item');
      const context = [];
      
      activityItems.forEach((item, index) => {
        const timestamp = item.querySelector('.activity-timestamp').textContent;
        const content = item.querySelector('.activity-content').textContent.replace('Raw Data', '').replace('‚ñº', '').replace('‚ñ≤', '').trim();
        const rawContent = item.querySelector('.activity-raw-content pre').textContent;
        
        context.push({
          actionNumber: index + 1,
          timestamp,
          summary: content,
          rawData: rawContent
        });
      });
      
      return context;
    }
  </script>
  </div>
</body>
</html>